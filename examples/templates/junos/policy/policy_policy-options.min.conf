# File: policy_policy-options.conf
# Author: Seung Lee (seungil.lee@global.ntt)
# Date: August 21, 2023
#
# Summary: template for policy-options
# OS: JUNOS >=15.1
# Description: minimum policy configuration
#
# Template Version: 1.0.0
# - Initial release
#
# Dependencies:
# - N/A



policy-options {
    prefix-list default-v6 {
        ::/0;
    }
    policy-statement next-hop-self {
        then {
            next-hop self;
            next policy;
        }
    }
    policy-statement static-or-direct {
        term no-default {
            from {
                protocol static;
                route-filter 0.0.0.0/0 exact;
            }
            then reject;
        }
        term match-static-direct {
            from protocol [ direct static ];
            then accept;
        }
    }
    policy-statement static-or-connected-v6 {
        /* Reject the default route. */
        term no-default {
            from {
                family inet6;
                protocol static;
                prefix-list default-v6;
            }
            then reject;
        }
        /* match routes in the list, mark routes as global and as core */
        term core-routes {
            from {
                family inet6;
                protocol static;
                route-filter {{core_prefix_v6}} exact;
            }
            then {
                metric 0;
                community add comm-core;
                community add comm-country;
                community add comm-region;
                community add comm-global;
                next policy;
            }
        }
        /* Mark all other direct/static routes as internal. */
        term match-static-or-direct {
            from {
                family inet6;
                protocol [ static direct ];
            }
            then {
                community add comm-internal;
                community add comm-country;
                next policy;
            }
        }
    }
    policy-statement ECM-forwarding {
        then {
            load-balance per-packet;
        }
    }
    policy-statement override-peer-MEDs {
        term peer-routes {
            from community comm-peers-wild;
            then {
                /* Largest MED = 2^32 - 2, not 2^32 - 1 due to cisco bug */
                metric 4294967294;
                next policy;
            }
        }
        then next policy;
    }
    /*
    * Final filter.
    */
    policy-statement final-filter {
        term fix-max-med {
            from metric 4294967295;
            then {
                metric 4294967294;
                next term;
            }
        }
        then accept;
    }
    
    community comm-internal members {{asn}}:350;
    community comm-global members {{asn}}:360;
    community comm-region members {{asn}}:3400;
    community comm-country members {{asn}}:2402;
    community comm-customer members {{asn}}:370;

    community comm-blackhole-outside-region members {{asn}}:660;
    community comm-blackhole-inside-region members {{asn}}:661;
    community comm-blackhole-inside-country members {{asn}}:663;
    community comm-blackhole-outside-country members {{asn}}:664;

    community comm-peers-wild members "^{{asn}}:39.$";
}